<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Heatmap</title>
        <link href="http://www.cs.fiu.edu/images/scislogo.png" rel="shortcut icon">
        <meta charset="UTF-8">        
        <script src="http://d3js.org/d3.v3.min.js"></script> 
        <script src="js/constants.js" type="text/javascript"></script>
        <script src="js/inputdb.js" type="text/javascript"></script>
        <script src="js/color.js" type="text/javascript"></script>
        <script src="js/handlers.js" type="text/javascript"></script>
        
        <link href="css/main.css" rel="stylesheet" type="text/css"/>
    </head>
    <body>
        <div><h1>Heatmap Analysis</h1></div>
        <div>
            <select id='dataSelection'>
                <option value="" selected>None</option>                
                <option value="sampledata">sampledata</option>
                <option value="Alexia">Alexia</option>
                <option value="Erika">Erika</option>
                <option value="Jasmin">Jasmin</option>
                <option value="Maria">Maria</option>
                <option value="Pedro">Pedro</option>
              </select>
            <select id='timeStep'>
                <option value="250" >250ms</option>
                <option value="500" selected>500ms</option>
            </select>
        </div>
        
        <div class="container">
            
        </div>
         
        <div class="selected-content" style="visibility:hidden">
            <div class="selected-content-title">DOI info</div>
            <div class="label">Type:</div>
            <div class="type small-font"></div>
            <div class="label">Flow:</div>
            <div class="navigation-text small-font"></div>
            <div class="label ">Type Text:</div>
            <div class="type-text small-font"></div>
            <div class="label data-content">Text:</div>
            <div class="data-text small-font"></div>
            <div class="media-image">
                <svg class="media-image-svg" width="500" >
                </svg>
            </div>
        </div>
        <div id='loading' style="display: none">
            <img src="images/loading_spinner.gif" alt=""/>
        </div>
        <script>
            
            inputdb.load();
            
            
            var svg = d3.select(".container").append("svg")
                    .attr("id", "mainsvg")
                    .attr("width", mainSVGwidth)
                    .attr("height", mainSVGheight)
                    .attr('class','main-svg')
                    .on('click', onSvgClick)
                ;
            
            
            d3.select('#dataSelection')
                    .on('change', function(){ 
                        if(this.value)
                        {
                            var timeStep = d3.select('#timeStep').node().value;
                            console.log(timeStep);
                            var filePath = 'data/'+this.value+timeStep+'.JSON';
                            loadFile(filePath);
                        }
                        else
                        {
                            initialize();
                        }
                    }
                );
            d3.select('#timeStep')
                    .on('change', function()
                        {
                            if(this.value){
                                var userName = d3.select('#dataSelection').node().value;
                                if(userName)
                                {
                                    var filePath = 'data/'+userName+this.value+'.JSON';
                                    loadFile(filePath);
                                }
                            }
                        })
            
            function loadFile(filePath)
            {
                d3.select('#loading').style('display','block');
                d3.select('.container').style('display','none');
                d3.json(filePath, function (error, data) {
                    if (error)
                        throw error;


                   render(data);
                   d3.select('#loading').style('display','none');
                   d3.select('.container').style('display','block');

                });
            }
            function initialize()
            {
               d3.select("svg").selectAll('.removable').remove();
               zoomListener.scale(1);
               zoomListener.translate([0,0]);
                d3.select('.selected-content')
                                        .style('visibility','hidden');
            }
            function getBackgroundRects(data, timeStep)
            {
                
                var totalTime = data.totalCells * timeStep;
                var totalRects = totalTime/backgroundTimeStep;
                var rectHeight = cellHeight * data.entryList.length;
                var rectWidth = cellWidth * backgroundTimeStep / timeStep;
                var rectData =[];
                
                for(var i=0;i<totalRects;i++)
                {
                    var fillColor ='';
                    if(i % 2 === 0)                            
                    {   
                       fillColor= '#D7DADB';
                    }
                    else
                    {
                        fillColor= '#F7FBFC';
                    }
                    var rect = {x:i*rectWidth, y: 0, w:rectWidth, h:rectHeight, fill:fillColor};
                    rectData.push(rect);
                }
                return rectData;
            }
            function getBackgroundLines(data, timeStep)
            {
                var totalTime = data.totalCells * timeStep;
                var totalLines = totalTime/backgroundTimeMarker;
                var lineGap = backgroundTimeMarker/timeStep /cellWidth;
                var lineHeight = cellHeight * data.entryList.length;
                var lineData =[];
                for(var i =0;i<totalLines;i++)
                {
                    var line = {x1: lineGap*i, y1:0, x2:lineGap*i, y2:lineHeight, text: ''+backgroundTimeMarker*i/60000+' min' };
                    lineData.push(line);
                }
                
                return lineData;
            }
            function render( data)
            {
                initialize();
                
                var zoomContainer = d3.select("svg").append('g')
                                .attr('id','zoomContainer')
                                .attr('class', 'removable')    
                                
                                .call(zoomListener);
                var baseGroup =zoomContainer.append('g')
                                .attr('id','base')
                    ;
                var heatmapGroup = baseGroup
                    .append('g')
                    .attr('id','heatmap')
                    .attr('transform','translate('+labelRectWidth+',0)')
                    .call(drag)
                ;
                var labelRectGroup = baseGroup.append('g')
                        .attr('id','labelRect')
                    ;
                
                var labelTextGroup = baseGroup.append('g')
                        .attr('id','labelText')
                    ;
                
                var hoverRectGroup = baseGroup.append('g')
                        .attr('id','hoverRect')
                        
                ;
                
                labelRectGroup.selectAll('rect').data(data.entryList)
                        .enter()
                        .insert('rect')
                        .attr('id', function(d,i){ return 'labelrect-'+i;})
                        .attr("x", function(d){ return cellWidth;})
                        .attr("y", function(d, j){ return j* cellHeight;})
                        .attr('width', labelRectWidth)
                        .attr('height',cellHeight)
                        .style({fill:function(d)
                                    { 
                                       return Color.getColorFromType(d.dataObject).getColorString();
                                    }
                                ,'stroke-width':1,stroke:'rgb(225,225,225)', 'fill-opacity':1})
                        .on('mouseover', onMouseOver)
                        .on('mouseout', onMouseOut)
                        .on('dblclick', onClick )
                        .append("svg:title")
                        .text(function(d) { return d.dataObject.label; })
                            ;
                
                var heatmapBackgroundGroup = heatmapGroup
                        .append('g')
                        .attr('id', 'heatmapBackground');
                
                var timeStep = d3.select('#timeStep').node().value;
                var backgroundRects = getBackgroundRects(data, timeStep);
                heatmapBackgroundGroup.selectAll('rect').data(backgroundRects)
                        .enter()
                        .insert('rect')
                        .attr("x", function(d){ return d.x;})
                        .attr("y", function(d){ return d.y;})
                        .attr('width', function(d){ return d.w;})
                        .attr('height',function(d) { return d.h;})
                        .attr('fill', function(d){return d.fill;})
                ;
                        
                
                var backgroundLines = getBackgroundLines(data, timeStep);
                heatmapBackgroundGroup.selectAll('line').data(backgroundLines)
                        .enter()
                        .insert('line')
                        .attr("x1", function(d){ return d.x1;})
                        .attr("y1", function(d){ return d.y1-20;})
                        .attr("x2", function(d){ return d.x2;})
                        .attr("y2", function(d){ return d.y2;})
                        .style({stroke:'rgb(0,0,0)', 'stroke-width':1}) 
                         .append("svg:title")
                        .text(function(d) { return d.text; })
                ;
                heatmapBackgroundGroup.selectAll('text').data(backgroundLines)
                        .enter()
                        .append('text')
                        .text(function(d) { return d.text;})
                        .attr("x", function(d){ return d.x1;})
                        .attr("y", function(d){ return d.y1-20;})  
                        .attr('font-family',"Verdana")
                        .attr('font-size','10')
                ;
                
                var heatmapImageGroup = heatmapGroup
                        .append('g')
                        .attr('id', 'heatmapImage');
                heatmapImageGroup.selectAll('image').data(data.entryList)
                        .enter()
                        .insert('svg:image')
                        .attr("xlink:href",function(d){return "data/"+d.imagePath;})
                        .attr('id', function(d,i){ return 'heatmapImage-'+i;})
                        .attr("x", function(d){ return cellWidth;})
                        .attr("y", function(d, j){ return j* cellHeight;})                          
                        .attr('width', data.totalCells * cellWidth)
                        .attr('height', cellHeight)
                        .on('mouseover', onMouseOver)
                        .on('mouseout', onMouseOut)
                        .on('dblclick', onClick )
                    
                        .append("svg:title")
                        .text(function(d) { return d.dataObject.label; })
                ;
                
                labelTextGroup.selectAll('text').data(data.entryList)
                        .enter()
                        .insert("text")
                        .attr('id', function(d,i){ return 'text-'+i;})
                        .text(function(d) { 
                            var id = d.dataObject.label;
                            var label = inputdb.getLabel(id);
                            return label; 
                        })
                        .attr("x", function(d){ return cellWidth;})
                        .attr("y", function(d, j){ return (j+1)* cellHeight;})                        
                        .attr('font-family',"Verdana")
                        .attr('font-size','10')
                        .on('mouseover', onMouseOver)
                        .on('mouseout', onMouseOut)
                        .on('dblclick', onClick )
                        .append("svg:title")
                        .text(function(d) { return d.dataObject.label; })
                ;
                
                hoverRectGroup.selectAll('rect').data(data.entryList)
                        .enter()
                        .insert('rect')
                        .attr('id', function(d,j){ return 'hover-'+j;})
                        .attr("x", function(d){ return cellWidth;})
                        .attr("y", function(d, j){ return j* cellHeight;})
                        .attr('width', labelRectWidth+data.totalCells * cellWidth)
                        .attr('height',cellHeight)
                        .style({fill:'none',stroke:'rgb(125,125,125)', 'stroke-opacity':1, 'visibility':'hidden'})
                        ;
            }
             </script>
       
        
    </body>
</html>
