<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Heatmap</title>
        <link href="http://www.cs.fiu.edu/images/scislogo.png" rel="shortcut icon">
        <meta charset="UTF-8">        
        <script src="http://d3js.org/d3.v3.min.js"></script> 
        <script src="js/color.js" type="text/javascript"></script>
        <link href="css/main.css" rel="stylesheet" type="text/css"/>
    </head>
    <body>
        <div><h1>Heatmap Analysis</h1></div>
        <div>
            <select id='dataSelection'>
                <option value="" selected>None</option>
                <option value="sampledata.JSON">sampledata</option>
                <option value="Alexia.JSON">Alexia</option>
                <option value="Erika.JSON">Erika</option>
                <option value="Jasmin.JSON">Jasmin</option>
                <option value="Maria.JSON">Maria</option>
                <option value="Pedro.JSON">Pedro</option>
              </select>
        </div>
        <div class="container">
            
        </div>
        <div id='loading' style="display: none">
            <img src="images/loading_spinner.gif" alt=""/>
        </div>
        <script>
            var width = 1280,
                height = 960;
            var cellWidth = 1;
            var cellHeight = 12;
            var rectData=[];
            
            var svg = d3.select(".container").append("svg")
                    .attr("id", "mainsvg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr('class','main-svg')
                ;
            
            var drag = d3.behavior.drag()
                .on("dragstart", dragstarted)
                .on("drag", dragged)
                .on("dragend", dragended);
            function dragstarted(d) {
                d3.event.sourceEvent.stopPropagation();
                d3.select(this).classed("dragging", true);
              }

              function dragged(d) {
                d3.select(this).attr("transform", "translate(" +  d3.event.x +",0)");
              }

              function dragended(d) {
                d3.select(this).classed("dragging", false);
              }
            
            function dragmoveX() {
                console.log('dragged');
              var x = d3.event.x;
              d3.select(this).attr("transform", "translate(" + x + ",0)");
            }
            
            var zoomListener = d3.behavior.zoom().scaleExtent([0.1, 3]).on("zoom", zoom);
            function zoom() {
                d3.select(this).attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
            }
            
            d3.select('#dataSelection')
                    .on('change', function(){ 
                        if(this.value)
                        {
                            d3.select('#loading').style('display','block');
                            d3.select('.container').style('display','none');
                            d3.json("data/"+this.value, function (error, data) {
                                if (error)
                                    throw error;
                                d3.select('#loading').style('display','none');
                                d3.select('.container').style('display','block');
                                rectData =[];
                                var v = -1;
                                for (var i=0; i<data.index.length; i++){
                                        if (data.dataObjects[data.index[i]].hidden)
                                                continue;

                                        v++;
                                        for (var j=0; j<data.heatmap[data.index[i]].length; j++){
                                                var colorScheme = Color.DEFAULT_COLOR_SCHEME;
                                                var c = Color.getColorFromRange(colorScheme, data.heatmap[data.index[i]][j]);
                                                var rect={color:c, x:j*cellWidth, y:v*cellHeight, w:cellWidth, h:cellHeight, obj:data.dataObjects[data.index[i]]};
                                                rectData.push(rect);
                                        }
                                }
                               render(rectData,data);

                            });
                        }
                        else
                        {
                            initialize();
                        }
                    }
                );
             
            function initialize()
            {
               d3.select("svg").selectAll('.removable').remove();
               zoomListener.scale(1);
               zoomListener.translate([0,0]);
            }
            
            function render(rectData, data)
            {
                initialize();
               
                var baseGroup =d3.select("svg").append('g')
                                .attr('id','base')
                                .attr('class', 'removable')    
                        .call(zoomListener)
                    ;
                var labelRectGroup = baseGroup.append('g')
                        .attr('id','labelRect')
                    ;
                var heatmapGroup = baseGroup
                        .append('g')
                        .attr('id','heatmap')
                        .attr('transform','translate(500,0)')
                        .call(drag)
                ;
                var labelTextGroup = baseGroup.append('g')
                        .attr('id','labelText')
                    ;
                
                
                
                labelRectGroup.selectAll('rect').data(data.viewedObjects)
                        .enter()
                        .insert('rect')
                        .attr("x", function(d){ return cellWidth;})
                        .attr("y", function(d, j){ return j* cellHeight;})
                        .attr('width', 500)
                        .attr('height',cellHeight)
                        .style({fill:function(d)
                                    { 
                                       return Color.getColorFromType(d).getColorString();
                                    }
                                ,'stroke-width':1,stroke:'rgb(225,225,225)'});
                            
                heatmapGroup.selectAll('rect').data(rectData)
                        .enter()
                        .insert('rect')
                        .attr("x", function(d){ return d.x;})
                        .attr("y", function(d){ return d.y;})   
                        .attr('width', function(d){ return d.w;})
                        .attr('height', function(d){ return d.h;})
                        .style({fill:function(d){return d.color.getColorString();},'stroke-width':0.01,stroke:'rgb(225,225,225)'})                        
                        .append("svg:title")
                        .text(function(d) { return d.obj.label; })
                
                ;
                
                labelTextGroup.selectAll('text').data(data.viewedObjects)
                        .enter()
                        .insert("text")
                        .text(function(d) { return d.label; })
                        .attr("x", function(d){ return cellWidth;})
                        .attr("y", function(d, j){ return (j+1)* cellHeight;})
                        .attr('font-family',"Verdana")
                        .attr('font-size','10');
                
        
                
                        
                    
            }
             </script>
       
        
    </body>
</html>
