<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Heatmap</title>
        <link href="http://www.cs.fiu.edu/images/scislogo.png" rel="shortcut icon">
        <meta charset="UTF-8">        
        <script src="http://d3js.org/d3.v3.min.js"></script> 
        <script src="js/inputdb.js" type="text/javascript"></script>
        <script src="js/color.js" type="text/javascript"></script>
        <link href="css/main.css" rel="stylesheet" type="text/css"/>
    </head>
    <body>
        <div><h1>Heatmap Analysis</h1></div>
        <div>
            <select id='dataSelection'>
                <option value="" selected>None</option>
                <option value="sampledata.JSON">sampledata</option>
                <option value="Alexia.JSON">Alexia</option>
                <option value="Erika.JSON">Erika</option>
                <option value="Jasmin.JSON">Jasmin</option>
                <option value="Maria.JSON">Maria</option>
                <option value="Pedro.JSON">Pedro</option>
              </select>
        </div>
        
        <div class="container">
            
        </div>
        <div class="selected-content">
            <h3>DOI info:</h3>
            <div class="label">Type:</div>
            <div class="type content-text"></div>
            <div class="label">Flow:</div>
            <div class="navigation-text content-text"></div>
            <div class="label content-text">Type Text:</div>
            <div class="type-text content-text "></div>
            <div class="label data-content">Text:</div>
            <div class="data-text"></div>
            <div class="media-image">
                <img />
                
            </div>
        </div>
        <div id='loading' style="display: none">
            <img src="images/loading_spinner.gif" alt=""/>
        </div>
        <script>
            var width = 1280,
                height = 300;
            var cellWidth = 1;
            var cellHeight = 12;
            inputdb.load();
            
            
            var svg = d3.select(".container").append("svg")
                    .attr("id", "mainsvg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr('class','main-svg')
                ;
            
            var drag = d3.behavior.drag()
                .on("dragstart", dragstarted)
                .on("drag", dragged)
                .on("dragend", dragended);
            var dragX =500;
            function dragstarted(d) {
                d3.event.sourceEvent.stopPropagation();
                d3.select(this).classed("dragging", true);
              }
              
              function dragged(d) {
                  dragX+= d3.event.dx;
                d3.select(this).attr("transform", "translate(" +  dragX+",0)");
              }

              function dragended(d) {
                d3.select(this).classed("dragging", false);
              }
            
            var zoomListener = d3.behavior.zoom().scaleExtent([0.1, 3]).on("zoom", zoom);
            function zoom() {
                d3.select('#base').attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
            }
            function onMouseOver()
            {
                var currentElementId = d3.select(this).attr('id');
                var index = currentElementId.split('-');
                var hoverId = 'hover-'+index[1];
                d3.select('#'+hoverId).style('visibility','visible');
            }
            function onMouseOut()
            {
                var currentElementId = d3.select(this).attr('id');
                var index = currentElementId.split('-');
                var hoverId = 'hover-'+index[1];
                d3.select('#'+hoverId).style('visibility','hidden');
            }
            d3.select('#dataSelection')
                    .on('change', function(){ 
                        if(this.value)
                        {
                            d3.select('#loading').style('display','block');
                            d3.select('.container').style('display','none');
                            d3.json("data/"+this.value, function (error, data) {
                                if (error)
                                    throw error;
                                
                              
                               render(data);
                               d3.select('#loading').style('display','none');
                               d3.select('.container').style('display','block');

                            });
                        }
                        else
                        {
                            initialize();
                        }
                    }
                );
             
            function initialize()
            {
               d3.select("svg").selectAll('.removable').remove();
               zoomListener.scale(1);
               zoomListener.translate([0,0]);
            }
            function render( data)
            {
                initialize();
               
                var zoomContainer = d3.select("svg").append('g')
                                .attr('id','zoomContainer')
                                .attr('class', 'removable')    
                                .call(zoomListener);
                var baseGroup =zoomContainer.append('g')
                                .attr('id','base')
                    ;
                var labelRectGroup = baseGroup.append('g')
                        .attr('id','labelRect')
                    ;
                var heatmapGroup = baseGroup
                        .append('g')
                        .attr('id','heatmap')
                        .attr('transform','translate(500,0)')
                        .call(drag)
                ;
                var labelTextGroup = baseGroup.append('g')
                        .attr('id','labelText')
                    ;
                
                var hoverRectGroup = baseGroup.append('g')
                        .attr('id','hoverRect')
                        
                ;
                
                labelRectGroup.selectAll('rect').data(data.entryList)
                        .enter()
                        .insert('rect')
                        .attr('id', function(d,i){ return 'labelrect-'+i;})
                        .attr("x", function(d){ return cellWidth;})
                        .attr("y", function(d, j){ return j* cellHeight;})
                        .attr('width', 500)
                        .attr('height',cellHeight)
                        .style({fill:function(d)
                                    { 
                                       return Color.getColorFromType(d.dataObject).getColorString();
                                    }
                                ,'stroke-width':1,stroke:'rgb(225,225,225)'})
                        .on('mouseover', onMouseOver)
                        .on('mouseout', onMouseOut)
                        .append("svg:title")
                        .text(function(d) { return d.dataObject.label; })
                            ;
                            
                heatmapGroup.selectAll('image').data(data.entryList)
                        .enter()
                        .insert('svg:image')
                        .attr("xlink:href",function(d){return "data/"+d.imagePath;})
                        .attr('id', function(d,i){ return 'heatmapImage-'+i;})
                        .attr("x", function(d){ return cellWidth;})
                        .attr("y", function(d, j){ return j* cellHeight;})                          
                        .attr('width', data.totalCells * cellWidth)
                        .attr('height', cellHeight)
                        .on('mouseover', onMouseOver)
                        .on('mouseout', onMouseOut)
                        .on('click', function(d, i)
                            {
                               
                                var selectedObject =inputdb.getContent(d.dataObject.label);
                                
                                d3.select('.type').text(selectedObject.type);
                                d3.select('.type-text').text(selectedObject.typeText);
                                d3.select('.navigation-text').text(selectedObject.navigationText);
                                
                                if(selectedObject.type ==='image'
                                        ||selectedObject.type ==='button')
                                {
                                    d3.select('.data-content').text('Image:')
                                    d3.select('.data-text').text('');
                                    d3.select('.media-image img').attr('src', 'input'+selectedObject.imagePath);
                                }
                                else if(selectedObject.type ==='aoi')
                                {
                                    d3.select('.media-image img').attr('src', 'inputdata/media/'+selectedObject.imagePath);
                                }
                                else if(selectedObject.type ==='text')
                                {
                                    var text = selectedObject.object;
                                    if(selectedObject.object.text)
                                    {
                                        text = selectedObject.object.text;
                                    }
                                    d3.select('.data-content').text('Text:');
                                    d3.select('.data-text').text(text);
                                    d3.select('.media-image img').attr('src','');
                                }
                            })
                    
                        .append("svg:title")
                        .text(function(d) { return d.dataObject.label; })
                ;
                
                labelTextGroup.selectAll('text').data(data.entryList)
                        .enter()
                        .insert("text")
                        .attr('id', function(d,i){ return 'text-'+i;})
                        .text(function(d) { return d.dataObject.label; })
                        .attr("x", function(d){ return cellWidth;})
                        .attr("y", function(d, j){ return (j+1)* cellHeight;})                        
                        .attr('font-family',"Verdana")
                        .attr('font-size','10')
                        .on('mouseover', onMouseOver)
                        .on('mouseout', onMouseOut)
                        .append("svg:title")
                        .text(function(d) { return d.dataObject.label; })
                ;
                
                hoverRectGroup.selectAll('rect').data(data.entryList)
                        .enter()
                        .insert('rect')
                        .attr('id', function(d,j){ return 'hover-'+j;})
                        .attr("x", function(d){ return cellWidth;})
                        .attr("y", function(d, j){ return j* cellHeight;})
                        .attr('width', 500+data.totalCells * cellWidth)
                        .attr('height',cellHeight)
                        .style({fill:'none',stroke:'rgb(125,125,125)', 'stroke-opacity':1, 'visibility':'hidden'})
                        ;
                        
                    
                
                
                    
            }
             </script>
       
        
    </body>
</html>
